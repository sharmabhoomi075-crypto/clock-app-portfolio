<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Portfolio-Grade Clock App</title>

<!-- Flatpickr for cross-browser date/time pickers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Choices.js for searchable multi-select -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
        background: #f4f4f4;
        transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
        background: #1e1e1e;
        color: #fff;
    }
    section {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background 0.3s, color 0.3s;
    }
    body.dark-mode section { background: #2b2b2b; color: #fff; }
    h2 { text-align: center; margin-top: 0; }
    label { display: block; margin: 5px 0; }
    input, select { margin: 2px 0; }
    button { margin: 2px; padding: 5px 10px; }
    .hidden { display: none; }
    #countdown-progress {
        height: 20px;
        background: green;
        border-radius: 10px;
        margin-top: 5px;
        transition: width 0.1s linear;
    }
    #laps { max-height: 100px; overflow-y: auto; padding-left: 20px; }

    /* Choices.js dark mode */
    body.dark-mode .choices__inner {
        background-color: #2b2b2b;
        color: #fff;
        border: 1px solid #555;
    }
    body.dark-mode .choices__list--dropdown {
        background-color: #2b2b2b;
        color: #fff;
    }
    body.dark-mode .choices__item {
        background-color: #444;
        color: #fff;
    }
    body.dark-mode .choices__list--dropdown .choices__item--selectable {
        background-color: #2b2b2b;
        color: #fff;
    }
    body.dark-mode .choices__list--dropdown .choices__item--highlighted {
        background-color: #555;
    }
    body.dark-mode .choices__placeholder { color: #ccc; }
</style>
</head>
<body>

<h1 id="page-title">Portfolio-Grade Clock App</h1>

<section>
    <h2>Theme</h2>
    <button id="theme-toggle">Toggle Dark/Light Mode</button>
</section>

<section>
    <h2>Clock</h2>
    <p id="clock-display"></p>
    <label for="timezone-select">World Clock:</label>
    <select id="timezone-select" multiple></select>
    <div id="world-clock-display"></div>
</section>

<section>
    <h2>Timer</h2>
    <label>Minutes: <input type="number" id="timer-minutes" value="0" min="0"></label>
    <label>Seconds: <input type="number" id="timer-seconds" value="0" min="0" max="59"></label>
    <label>Run: <input type="checkbox" id="timer-run"></label>
    <p id="timer-display"></p>
</section>

<section>
    <h2>Stopwatch</h2>
    <p id="stopwatch-display">0:00:00.000</p>
    <button id="sw-start">Start</button>
    <button id="sw-stop" disabled>Stop</button>
    <button id="sw-reset">Reset</button>
    <button id="sw-lap">Lap</button>
    <ul id="laps"></ul>
</section>

<section>
    <h2>Countdown</h2>
    <label>Date: <input type="text" id="countdown-date" placeholder="Select Date"></label>
    <label>Time: <input type="text" id="countdown-time" placeholder="Select Time"></label>
    <p id="countdown-display"></p>
    <div id="countdown-progress"></div>
    <p id="countdown-over" class="hidden">Countdown Over!</p>
</section>

<audio id="timer-alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
'use strict';

/* ========= Ticker ========= */
class Ticker {
    constructor() {
        if (Ticker.instance) return Ticker.instance;
        this.observers = [];
        Ticker.instance = this;
        this.run();
    }
    addObserver(o) { this.observers.push(o); }
    notify() { this.observers.forEach(o => o.update && o.update()); }
    run() { setInterval(() => this.notify(), 1000); }
}

/* ========= Clock ========= */
class Clock {
    constructor(el) { this.el = el; new Ticker().addObserver(this); }
    update() { this.el.textContent = new Date().toLocaleTimeString(); }
}

/* ========= World Clock ========= */
class WorldClock {
    constructor(selectEl, displayEl) {
        this.selectEl = selectEl; this.displayEl = displayEl;
        new Ticker().addObserver(this);
    }
    update() {
        this.displayEl.innerHTML = '';
        Array.from(this.selectEl.selectedOptions).forEach(opt => {
            const now = new Date().toLocaleTimeString('en-US', {timeZone: opt.value});
            const p = document.createElement('p'); p.textContent = `${opt.text}: ${now}`; 
            this.displayEl.appendChild(p);
        });
    }
}

/* ========= Timer ========= */
class Timer {
    constructor(minEl, secEl, chkEl, displayEl) {
        this.minEl = minEl; this.secEl = secEl;
        this.chkEl = chkEl; this.display = displayEl;
        this.timeLeft = 0; this.running=false; this.resetNeeded=true;
        this.audio=document.getElementById('timer-alarm');

        minEl.addEventListener('input', ()=>this.resetNeeded=true);
        secEl.addEventListener('input', ()=>this.resetNeeded=true);
        chkEl.addEventListener('change', ()=>chkEl.checked?this.start():this.stop());
        new Ticker().addObserver(this);
    }
    start() {
        if(!this.running) {
            if(this.timeLeft<=0||this.resetNeeded) this.timeLeft=parseInt(this.minEl.value)*60+parseInt(this.secEl.value)||0, this.resetNeeded=false;
            if(this.timeLeft<=0){this.display.textContent='Set time first'; this.chkEl.checked=false; return;}
            this.running=true; this.minEl.disabled=true; this.secEl.disabled=true;
        }
    }
    stop(){this.running=false; this.display.textContent='Timer stopped'; this.minEl.disabled=false; this.secEl.disabled=false; }
    update(){if(!this.running) return;
        if(this.timeLeft>0){const m=Math.floor(this.timeLeft/60); const s=this.timeLeft%60; this.display.textContent=`${m}m ${s}s`; this.timeLeft--;} 
        else {this.display.textContent="Time's Up!"; this.running=false; this.chkEl.checked=false; this.minEl.disabled=false; this.secEl.disabled=false; this.audio.play();}
    }
}

/* ========= Stopwatch ========= */
class Stopwatch {
    constructor(display, startBtn, stopBtn, resetBtn, lapBtn, lapsList) {
        this.display = display; this.startBtn=startBtn; this.stopBtn=stopBtn; this.resetBtn=resetBtn;
        this.lapBtn=lapBtn; this.lapsList=lapsList;
        this.running=false; this.startTime=0; this.elapsed=0;
        startBtn.addEventListener('click', ()=>this.start());
        stopBtn.addEventListener('click', ()=>this.stop());
        resetBtn.addEventListener('click', ()=>this.reset());
        lapBtn.addEventListener('click', ()=>this.lap());
    }
    start(){if(!this.running){this.running=true; this.startTime=Date.now()-this.elapsed; this.startBtn.disabled=true; this.stopBtn.disabled=false; this.animate();}}
    stop(){if(this.running){this.running=false; this.elapsed=Date.now()-this.startTime; this.startBtn.disabled=false; this.stopBtn.disabled=true;}}
    reset(){this.running=false; this.elapsed=0; this.startBtn.disabled=false; this.stopBtn.disabled=true; this.updateDisplay(); this.lapsList.innerHTML='';}
    lap(){if(this.running){const li=document.createElement('li'); li.textContent=this.display.textContent; this.lapsList.appendChild(li);}}
    animate(){if(!this.running) return; this.elapsed=Date.now()-this.startTime; this.updateDisplay(); requestAnimationFrame(()=>this.animate());}
    updateDisplay(){const ms=this.elapsed%1000, totalSec=Math.floor(this.elapsed/1000), s=totalSec%60, m=Math.floor(totalSec/60)%60, h=Math.floor(totalSec/3600);
        this.display.textContent=`${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${ms.toString().padStart(3,'0')}`;
    }
}

/* ========= Countdown ========= */
class Countdown {
    constructor(dateInput, timeInput, display, hiddenMsg, progressBar){
        this.dateInput=dateInput; this.timeInput=timeInput; this.display=display; this.hiddenMsg=hiddenMsg; this.progressBar=progressBar;
        this.notified=false; new Ticker().addObserver(this);
        if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();
    }
    update(){
        if(!this.dateInput.value||!this.timeInput.value) return;
        const target=new Date(`${this.dateInput.value}T${this.timeInput.value}`); if(!target.getTime()) return;
        const now=new Date(), past=now>target, diff=Math.abs(target-now), total=diff;
        const days=Math.floor(diff/86400000), hours=Math.floor((diff%86400000)/3600000),
              minutes=Math.floor((diff%3600000)/60000), seconds=Math.floor((diff%60000)/1000);
        this.display.textContent=`${days}d ${hours}h ${minutes}m ${seconds}s ${past?'ago':'remaining'}`;
        this.progressBar.style.width=past?'100%':`${100-(diff/total*100)}%`;
        past?this.hiddenMsg.classList.remove('hidden'):this.hiddenMsg.classList.add('hidden');
        if(!this.notified && past && Notification.permission==="granted"){new Notification("Countdown Over!"); this.notified=true;}
    }
}

/* ========= Initialize ========= */
function main(){
    new Ticker();
    new Clock(document.getElementById('clock-display'));
    new WorldClock(document.getElementById('timezone-select'), document.getElementById('world-clock-display'));
    new Timer(document.getElementById('timer-minutes'), document.getElementById('timer-seconds'), document.getElementById('timer-run'), document.getElementById('timer-display'));
    new Stopwatch(document.getElementById('stopwatch-display'), document.getElementById('sw-start'), document.getElementById('sw-stop'), document.getElementById('sw-reset'), document.getElementById('sw-lap'), document.getElementById('laps'));
    new Countdown(document.getElementById('countdown-date'), document.getElementById('countdown-time'), document.getElementById('countdown-display'), document.getElementById('countdown-over'), document.getElementById('countdown-progress'));

    // Flatpickr for date/time
    flatpickr("#countdown-date", { dateFormat: "Y-m-d" });
    flatpickr("#countdown-time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });

    // Populate World Clock select dynamically
    const tzSelect = document.getElementById('timezone-select');
    const timezones = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : ["America/New_York","Europe/London","Asia/Kolkata","Asia/Tokyo","Australia/Sydney"];
    timezones.forEach(tz => { const option = document.createElement('option'); option.value = tz; option.textContent = tz.replace('_',' '); tzSelect.appendChild(option); });
    
    // Make searchable
    new Choices(tzSelect, { removeItemButton: true, searchEnabled: true });

    // Dark/Light mode
    document.getElementById('theme-toggle').addEventListener('click', ()=>document.body.classList.toggle('dark-mode'));
}

window.addEventListener('load', main);
</script>

</body>
</html>